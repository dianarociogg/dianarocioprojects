---
title: "Distribución datos del censo"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## 1. Introducción. 

Se puede preveer que algunos datos del Censo de Población y Vivienda no estén georreferenciados a nivel de manzana. En estos casos, por la forma en la que se realiza el operativo censal es posible identificar en qué área geográfica se diligenció un determinado formulario, sin embargo  esto implica una pérdida de detalle geográfico, dado que el área geográfica abarca varias manzanas. 

Como alternativa para localizar espacialmente el número de personas y viviendas del censo, se plantea  utilizar una variable auxiliar que esté disponible a nivel de manzana. La misma debe brindar información sobre la probabilidad de que la variable objetivo tome determinado valor y  ser lo más completa posible. La que recoge mejor estas características es el número total de viviendas, obtenida en el preconteo previo al censo. 

El presente ejercicio busca establecer los algoritmos necesarios para realizar esta distribución espacial de unidades no georreferenciadas con el apoyo de una variable auxiliar. Dado que la información disponible del actual censo de población no está completa a la fecha de elaboración del presente informe, se decidió realizar un proceso de prueba buscando distribuir la variable "área construida" proveniente del registro tipo 1 del IGAC con vigencia 2017. El trabajo se realizó para las manzanas con cardinalidad 2, tomando como base una tabla que había sido calculada previamente. 

La cardinalidad 2 significa que al cruzar el registro del IGAC con el de áreas operativas del DANE, no hay una correspondencia biunívoca entre las claves primarias de los dos conjuntos de datos, sino que, por el contrario, a cada código catastral del IGAC corresponden varios códigos de área geográfica del DANE. La idea es entonces distribuir el valor total del área de construcción para las viviendas catastrales, utilizando como variable auxiliar el número total de viviendas del preconteo del DANE. 

Para hacer el ejercicio se comienza cargando los paquetes necesarios y realizando  una conexión con postgresql, para descargar luego algunos conjuntos de datos.

## 2. Instalación de paquetes y configuración de conexión a Postgresql

```{r, warning=FALSE, message=FALSE, results=FALSE}
##trace(utils:::unpackPkgZip, edit=TRUE)
paquetes <-c("audio", "RPostgreSQL", "tidyverse", "foreign", 
               "ggplot2","openxlsx", "rgdal", "beepr","sf","parallel", "spData", 
               'units', "data.table", "spatialEco","bit","bit64", "stringi", "Hmisc", "beepr")
nuevos.paquetes<-paquetes[!(paquetes %in% installed.packages()[,"Package"])]
if(length(nuevos.paquetes)) install.packages(nuevos.paquetes)
lapply(paquetes, require, character.only=TRUE)
  
  
## Configuro ruta y establezco conexión----
drv<-dbDriver("PostgreSQL")
con <- dbConnect(drv, user= "postgres", port='5432', password="javier", dbname="ciudades")
dbSendQuery(con, "set search_path to ciudades")
```

## 3. Importación de tablas y cálculo para distribución de la variable de interés.


Importo al espacio de trabajo las tres tablas con las que se va a trabajar:  1.  la  de unidades de cobertura urbana (ucu17) 2.  las ciudades priorizadas(priorizadas), 3. los registros catastrales del IGAC con cardinalidad 2 (reg1c2).

```{r}
reg1c2<-dbReadTable(con, "reg1c2")
ucu<-dbReadTable(con, "ucu17")
colnames(ucu)<-tolower(colnames(ucu))
priorizadas<-dbReadTable(con, "priorizadas")
```

A continuación realizo el proceso de cálculo.  Consiste en seleccionar las variables de interés de la tabla reg1c2 estas son el código catastral, el código de áre geográfica del DANE -cod_ag-, el total de viviendas que es la variable auxiliar, y el área construida que es la variable a distribuir.  En segundo lugar se crea una tabla auxiliar con los totales de viviendas por código catastral. Este resultado, a su vez,  se pega a la tabla original y sirve para calcular la proporción de viviendas para cada unidad del código catastral -prop.viv-. Esta misma proporción se aplica al área construida, con lo que se distribuye la variable de interés.

```{r}
datos<-reg1c2%>%dplyr::select(cod_catastro,cod_ag, viv_total, area.construida)
viv.tot<-datos%>%group_by(cod_catastro)%>%summarise(viv.total=sum(viv_total, na.rm=TRUE))
datos<-merge(datos, viv.tot, by.x="cod_catastro", by.y="cod_catastro")
datos<-datos%>%mutate(prop.viv=viv_total/viv.total, area_estimada=round(area.construida*prop.viv,1))%>%select(cod_catastro, cod_ag, viv_total, area.construida, viv.total, prop.viv, area_estimada)
head(datos%>%filter(!is.na(area_estimada)))
```


## 3. Distribución geográfica de variable con un porcentaje de unidades georreferenciadas. 

Puede suceder que una parte de los registros de un área operativa se hayan georreferenciado, pero no así para el resto de ellos. En este caso se agrega un paso más. Se supone que para cada manzana  una proporción de la variable ha sido georreferenciada. En este caso se deben eliminar primero las manzanas en la que los formularios estén completamente georreferenciados. Para el resto de ellas se procede igual que en el caso anterior. 





En este caso hay que establecerse la capacidad de carga restante y distribuir en función de la misma los registros no georreferenciados.  Para ejemplificar esta situación y hacer explícita la forma de resolverla se tomará el subconjunto de datos anterior , se simulará que una proporción de los datos no han sido completamente georreferenciados y se planteará la forma de resolverlo.




La simulación se hace generando una probabilidad en el intervalo 0 a 1 para cada registro utilizando una distribución uniforme.  Se trata de una distribución en la que todos los intervalos de la misma longitud tienen la misma probabilidad de ocurrencia. El valor del área construida georreferenciada se supondrá igual al valor del área construida total por el número aleatorio obtenido. La del área no georreferenciada será su complemento. 

Sobre el número aleatorio debe considerarse lo siguiente: el valor total georreferenciado en una unidad catastral se supone aleatorio.  Al mismo tiempo, dentro de esta unidad, la proporción georreferenciada de cada manzana DANE también es aleatoria. Para simular entonces se genera un valor aleatorio entre cero a uno y luego un conjunto de valores aleatorios que sumen este último valor, cuyo número es igual al de manzanas DANE dentro de la manzana catastral.  

```{r}
cod_catastro<-datos%>%group_by(cod_catastro)%>%summarise(conteo=n())
cod_catastro$runif<-runif(n=dim(cod_catastro)[1])

datos<-merge(datos, cod_catastro, by.x="cod_catastro", by.y="cod_catastro")

prob.geo<-vector()
for (i in 1: dim(cod_catastro)[1]){
x<-runif(cod_catastro$conteo[i])
prob.geo0<-x*cod_catastro$runif[i]/sum(x)
prob.geo<-c(prob.geo,prob.geo0)
}

datos<-cbind(datos, prob.geo)
head(datos%>%filter(!is.na(area.construida)))
```

A continuación simulo el área construida que está efectivamente georreferenciada. También el área no georreferenciada, de la cual no sabemos su distribución por manzana DANE sino únicamente el total por manzana catastral. 


```{r, eval=TRUE}
datos<-datos%>%mutate(const.geo.ag=round(prob.geo*area.construida))
cod_catastro<-datos%>%group_by(cod_catastro)%>%summarise(const.geo.cat=sum(const.geo.ag))
datos<-merge(datos, cod_catastro, by.x="cod_catastro", by.y="cod_catastro")
datos<-datos%>%mutate(const.no.geo.cat=area.construida-const.geo.cat)
colnames(datos)<-c("cod_catastro", "cod_ag", "viv.mz.dane", "area.construida","viv.mz.ctstro", 
                   "prop.viv","area_estimada","conteo","runif","prob.geo","const.geo.ag", "const.geo.cat","const.no.geo.cat")
```

Los datos necesarios para el ejercicio son los siguientes: 

1. Código catastral
2. Código DANE (AG)
3. Número de viviendas por código AG
4. Total de área georreferenciada por AG.
5. Total de área construida para la manzana catastral. 
6. Número de unidades georreferenciadas en una manzana dada. 

A continuación se verifica que efectivamente estas son las columnas presentes en la tabla. 

```{r, eval=TRUE}
head(datos%>%filter(!is.na(area.construida)))
```

Ahora bien, el proceso para distribuir la variable de interés por manzana consiste en los siguientes pasos: 

1. Realizo un cálculo del total de viviendas. 
2. Pego el total de viviendas a la tabla anterior. 
3. Calculo la proporción de viviendas en una manzana DANE respecto al total de viviendas en la manzana catastral. 
4. Multiplico la proporción de viviendas por el área para hallar la "capacidad de soporte" de área de construcción por manzana DANE.


```{r, eval=TRUE}
datos<-datos%>%mutate(prop.viv=viv.mz.dane /viv.mz.ctstro, soporte=area_estimada-const.geo.ag)
head(datos%>%filter(!is.na(area.construida)))
```

head(datos%>%filter(!is.na(area.construida)))

Tengo un total de población para distribuir entre un soporte.  EL soporte es el área estimada menos el área georreferenciada.

5. Identifico del total del soporte de la manzana cuanto está sin georreferenciar. Esto lo hago restanto la capacidad de soporte del área efectivamente georreferenciada. 
6. Calculo el total de área sin georreferenciar. 
7. Identifico la proporción de la capacidad de soporte no georreferenciada
8. Distribuyo el área sin georreferenciar multiplicando el total de viviendas por la proporción de soporte no georreferenciado
9. Sumo el área no georreferenciada y la georreferenciada para comprobar que los datos proporcionan valores similares

Selecciono únicamente las columnas que voy a necesitar. 
Simplemente el área a ubicar en cada manzana es la diferencia entre el área estimada y el área georreferenciada en cada manzana. 

Localización de no georreferenciados es igual a: 

datos1<-datos%>%select(cod_catastro, cod_ag, viv.mz.dane, area.construida,
area_estimada, const.geo.ag, const.no.geo.cat,soporte)%>%mutate(distribuye=area_estimada-const.geo.ag)

head(datos1%>%filter(!is.na(area.construida)))

##Con esto obtengo el resultado esperado. 
