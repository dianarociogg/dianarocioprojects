---
title: "Centro de Operaciones Nacional - CONAL"
subtitle: "Análisis de seguimiento CNPV 2018"
date: "`r format(Sys.time(), '%d de %B de %Y')`"
output:
  html_document:
    toc: true
    toc_depth: 2
    theme: flatly
    highlight: haddock
    toc_float: yes
  pdf_document:
    toc: yes
    toc_depth: '3'
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

<style>
#TOC {
  #background: url('LogoDANEconal.png');
  background: url('http://intranet.dane.gov.co/images/Imagen_Institucional/Logo/LogoDANE_Hor.jpg');
  background-size: contain;
  padding-top: 80px !important;
  background-repeat: no-repeat;
}
</style>


El siguiente reporte contiene los resultados del seguimiento y registro de requerimientos del nivel departamental y municipal de la estructura operativa del CNPV.

#  Balance inicio de operación

```{r, include = FALSE}

paquetes<-c("sp","raster","rgdal","rgeos","maptools","ggplot2","gridExtra","spdep","RColorBrewer","reshape2","spatstat","scales","spdep","leaflet","maps","viridis","classInt","plotly")
# vector con los paquetes no instalados
instalaciones<-paquetes[!paquetes %in% installed.packages()]
# iteración para descargar los paquetes sin instalar
for(libs in instalaciones) install.packages(libs)
# carga de paquetes
sapply(paquetes,require,character=TRUE)


# Cambiar según ubicación de librería Rtools en el equipo de trabajo
Sys.setenv("R_ZIPCMD"='C:/Rtools/bin/zip.exe') 
```

```{r, include = FALSE}
DPTOS<-readOGR(dsn="C:/Users/drgalindog/Downloads/VDAS_simpli",layer="MGN_ADM_DPTO_POLITICO",stringsAsFactors=FALSE,use_iconv=TRUE,encoding="UTF-8")
str(DPTOS@data)

MPIOS<-readOGR(dsn="C:/Users/drgalindog/Downloads/VDAS_simpli",layer="mpiosimplif2",stringsAsFactors=FALSE,use_iconv=TRUE,encoding="UTF-8")

CONAL<-readOGR(dsn="C:/Users/drgalindog/Downloads/VDAS_simpli",layer="Seg_CONAL2",stringsAsFactors=FALSE,use_iconv=TRUE,encoding="UTF-8",integer64="allow.loss")

str(MPIOS@data)

CAPITALES<-readOGR(dsn="C:/Users/drgalindog/Downloads/VDAS_simpli",layer="CAPITALES",stringsAsFactors=FALSE,use_iconv=TRUE,encoding="UTF-8")

str(CAPITALES@data)

```

En relación al inicio de la operación, se solicitó a las coordinaciones departamentales el reporte de los municipios con inicio efectivo de la operación. De los 481 municipios de fase 2 se ha dado inicio en `r a<-length(MPIOS[MPIOS$INICIO == 'Si',]); a`, correspondiente al `r round(a/481*100,digits=2)`%.  EL siguiente mapa muestra en verde  los municipios con inicio de la operación censal  a la fecha de este reporte:

```{r, echo=FALSE}
#VDASPrueba<-VDAS_DATOS
#factpal <- colorFactor(magma(10), VDASPrueba$CODIGO_VER)
#leaflet(data = VDASPrueba) %>% addProviderTiles("OpenStreetMap.BlackAndWhite") %>% 
#        setView(-73.800,4.500,zoom = 8) %>% 
#        addPolygons(fillColor = ~factpal(CODIGO_VER), stroke = FALSE,
#                    popup = paste(VDAS$CODIGO_VER,"\n",VDAS$NOMBRE_VER))

factpal <- colorFactor(c('#FFFFBE', '#B2B2B2', '#70A800'), MPIOS$INICIO)

map <- leaflet(data= CAPITALES) %>%
  
  ## Base group: default OpenStreetMap map tiles
  addProviderTiles("OpenStreetMap.Mapnik") %>%  setView(-74.0382679, 4.3489054, zoom = 11) %>%
  fitBounds(-78.201032746, 2.678125512, -71.6273344832, 11.552618168)%>%
  
  ## Overlay groups
  addCircleMarkers(radius = 2.2 ,stroke = FALSE, fillOpacity = 1, color = "#525252") %>%
  addPolygons(data = MPIOS[MPIOS$FASE == 2,], stroke = FALSE, fillOpacity = 0.8,
              fillColor = ~factpal(INICIO)) %>%

  ## Layers control
addLayersControl(overlayGroups = c("Capitales", "Municipios Fase 2"),
    options = layersControlOptions(collapsed = FALSE))%>%

  # Add legend
  addLegend(pal = factpal, values = MPIOS$INICIO, opacity = 0.7, title = 'Estado   inicio',position = "bottomleft")

map

```

# Requerimientos atendidos por el CONAL

La distribución geográfica de los requerimientos atendidos por el CONAL A `r format(Sys.Date(), "%B %d de %Y ")` es:

```{r, echo=FALSE}

fasepal <- colorFactor(c('#800026', '#e31a1c', '#fd8d3c'), MPIOS$FASE)
map2 <- leaflet(data=CONAL) %>%
  
  ## Base group: default OpenStreetMap map tiles
 addProviderTiles("OpenStreetMap.BlackAndWhite") %>% 
  fitBounds(-81, -4.5, -67, 12)%>%
  
  ## Overlay groups
  addMarkers(clusterOptions = markerClusterOptions())%>%
  addPolygons(data = MPIOS, stroke = FALSE, fillOpacity = 0.30,
              fillColor = ~fasepal(FASE))%>%
 
  ## Layers control
  #addLayersControl(overlayGroups = c("Capitales", "Municipios Fase 2"),
  #  options = layersControlOptions(collapsed = FALSE))%>%

  # Add legend
  addLegend(pal = fasepal, values = MPIOS$FASE, opacity = 0.7, title = 'Fase de inicio',position = "bottomright")

map2

```
El número de requerimientos por Departamento y tipo de requerimiento se ve puede ver en la siguiente gráfica:

```{r, echo=FALSE}
pie<-data.frame(unlist(lapply(CONAL@data[, 17:23],sum)))
pie$etiquetas<-c("Personal","Insumos","Transporte","Externalidades","Pre-Operativo","Operativo","TIC")
colnames(pie)<-c("Conteo","Etiqueta")

colors <- c('rgb(211,94,96)', 'rgb(128,133,133)', 'rgb(144,103,167)', 'rgb(171,104,87)', 'rgb(114,147,203)', 'rgb(77,175,74)', 'rgb(255,127,0)')

p <- plot_ly(pie, labels = ~Etiqueta, values = ~Conteo, type = 'pie',
        textposition = 'inside',
        textinfo = 'label+percent',
        insidetextfont = list(color = '#FFFFFF'),
        hoverinfo = 'text',
        text = ~paste(Conteo, 'solicitudes'),
        marker = list(colors = colors,
                      line = list(color = '#FFFFFF', width = 1)),
        showlegend = FALSE) %>%
  layout(title = 'Proporción de requerimientos de acuerdo al tipo',
         xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
         yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))

p
```

```{r, echo=FALSE}
cons_dpto<-CONAL@data[,c(17:23,14)]

p <- plot_ly(cons_dpto, x = ~ETQ_Dptos, y = ~C_Personal, type = 'bar', name = 'Personal') %>%
  add_trace(y = ~C__TIC, name = 'TIC') %>%
  add_trace(y = ~C_Insumos, name = 'Insumos') %>%
  add_trace(y = ~C_Operativ, name = 'Operativo') %>%
  add_trace(y = ~C_PreOpera, name = 'PreOperativo') %>%
  add_trace(y = ~C_Transpor, name = 'Transporte') %>%
  add_trace(y = ~C_External, name = 'Externalidades') %>%
  layout(margin = list(b = 100),yaxis = list(title = 'Nro. de requerimientos'), xaxis = list(title = "", tickangle = -90),barmode = 'stack',legend = list(x = 0.1, y = 0.9))
p

```
