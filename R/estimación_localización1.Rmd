---
title: "Propuesta de localización de datos del censo a nivel de AG"
subtitle: "Javier Jácome"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## 1. Introducción. 

Se puede preveer que algunos datos del Censo de Población y Vivienda no estén georreferenciados a nivel de manzana. En estos casos, por la forma en la que se realiza el operativo censal es posible identificar en qué área geográfica se diligenció un determinado formulario, sin embargo  esto implica una pérdida de detalle geográfico, dado que el área geográfica abarca varias manzanas. 

Como alternativa para localizar espacialmente el número de personas y viviendas del censo, se plantea  utilizar una variable auxiliar que esté disponible a nivel de manzana. La misma debe brindar información sobre la probabilidad de que la variable objetivo tome determinado valor y  ser lo más completa posible. La que recoge mejor estas características es el número total de viviendas, obtenida en el preconteo previo al censo. 

El presente ejercicio busca establecer los algoritmos necesarios para realizar esta distribución espacial de unidades no georreferenciadas con el apoyo de una variable auxiliar. Dado que la información disponible del actual censo de población no está completa a la fecha de elaboración del presente informe, se decidió realizar un proceso de prueba buscando distribuir la variable "área construida" proveniente del registro tipo 1 del IGAC con vigencia 2017. El trabajo se realizó para las manzanas con cardinalidad 2, tomando como base una tabla que había sido calculada previamente. 

La cardinalidad 2 significa que al cruzar el registro del IGAC con el de áreas operativas del DANE, no hay una correspondencia biunívoca entre las claves primarias de los dos conjuntos de datos, sino que, por el contrario, a cada código catastral del IGAC corresponden varios códigos de área geográfica del DANE. La idea es entonces distribuir el valor total del área de construcción para las viviendas catastrales, utilizando como variable auxiliar el número total de viviendas del preconteo del DANE. 

Para hacer el ejercicio se comienza cargando los paquetes necesarios y realizando  una conexión con postgresql, para descargar luego algunos conjuntos de datos.

## 2. Instalación de paquetes y configuración de conexión a Postgresql

```{r, warning=FALSE, message=FALSE, results=FALSE}
##trace(utils:::unpackPkgZip, edit=TRUE)
paquetes <-c("audio", "RPostgreSQL", "tidyverse", "foreign", 
               "ggplot2","openxlsx", "rgdal", "beepr","sf","parallel", "spData", 
               'units', "data.table", "spatialEco","bit","bit64", "stringi", "Hmisc", "beepr")
nuevos.paquetes<-paquetes[!(paquetes %in% installed.packages()[,"Package"])]
if(length(nuevos.paquetes)) install.packages(nuevos.paquetes)
lapply(paquetes, require, character.only=TRUE)
  
  
## Configuro ruta y establezco conexión----
drv<-dbDriver("PostgreSQL")
con <- dbConnect(drv, user= "postgres", port='5432', password="javier", dbname="ciudades")
dbSendQuery(con, "set search_path to ciudades")
```

## 3. Importación de tablas y cálculo para distribución de la variable de interés.


Importo al espacio de trabajo las tres tablas con las que se va a trabajar:  1.  la  de unidades de cobertura urbana (ucu17) 2.  las ciudades priorizadas(priorizadas), 3. los registros catastrales del IGAC con cardinalidad 2 (reg1c2).

```{r}
reg1c2<-dbReadTable(con, "reg1c2")
ucu<-dbReadTable(con, "ucu17")
colnames(ucu)<-tolower(colnames(ucu))
priorizadas<-dbReadTable(con, "priorizadas")
```

A continuación realizo el proceso de cálculo.  Consiste en seleccionar las variables de interés de la tabla reg1c2 estas son el código catastral, el código de áre geográfica del DANE -cod_ag-, el total de viviendas que es la variable auxiliar, y el área construida que es la variable a distribuir.  En segundo lugar se crea una tabla auxiliar con los totales de viviendas por código catastral. Este resultado, a su vez,  se pega a la tabla original y sirve para calcular la proporción de viviendas para cada unidad del código catastral -prop.viv-. Esta misma proporción se aplica al área construida, con lo que se distribuye la variable de interés.

```{r}
datos<-reg1c2%>%dplyr::select(cod_catastro,cod_ag, viv_total, area.construida)
viv.tot<-datos%>%group_by(cod_catastro)%>%summarise(viv.total=sum(viv_total, na.rm=TRUE))
datos<-merge(datos, viv.tot, by.x="cod_catastro", by.y="cod_catastro")
datos<-datos%>%mutate(prop.viv=viv_total/viv.total, area_estimada=round(area.construida*prop.viv,1))%>%select(cod_catastro, cod_ag, viv_total, area.construida, viv.total, prop.viv, area_estimada)
head(datos%>%filter(!is.na(area_estimada)))
```


## 4. Distribución geográfica de variable con un porcentaje de unidades georreferenciadas. 

Puede suceder que una parte de los registros de un área operativa se hayan georreferenciado, pero no así para el resto de ellos. En este caso se agrega un paso más. Se supone que para cada manzana  una proporción de la variable ha sido georreferenciada. En este caso se deben eliminar primero las manzanas en la que los formularios estén completamente georreferenciados. Para el resto de ellas se procede igual que en el caso anterior. 


