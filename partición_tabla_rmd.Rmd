---
title: "Partición de archivo con direcciones para diferentes entidades"
author: "Javier Jácome"
date: "16 de abril de 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## 1. Introducción.

Para este ejercicio se recibió una tabla con 10.200.510 registros y 128 columnas.  Contiene información de dirección para personas según diferentes proveedores. Para cada proveedor la tabla tiene 7 campos: id_estadístico, dirección, dirección_normalizada, ag_manzana, coordenada_x,  coordenada_y y número predial.  El requerimiento especificaba separar las tablas según proveedor, manteniendo únicamete los campos id_estadístico, dirección y dirección_normalizada.  Para identificación general, cada una de ellas debería tener dos columnas adicionales: id_estadístico e id_proveedor. 

Se comienza cargando los paquetes necesarios: 

```{r, message=TRUE, warning=TRUE}
library(data.table)
library(openxlsx)
library(stringr)
library(tidyverse)
library(ff)
```

## 2. Tabla Diccionario.

Se comienza leyendo el diccionario de datos. Los nombres especificados ahí son puesto luego como nombres de columna a la tabla con todos los datos. 

```{r}
diccionario<-read.xlsx("DICCIONARIO DE DATOS REBP.XLSX", startRow=3, cols=2:4, sheet="DICCIONARIO IDENTIFICADORES")
```

Para facilitar el procesamiento posterior se comienza convirtiéndolos a minúsculas y quitando espacios vacíos 

```{r}
colnames(diccionario)<-c("nomb.var", "descrip.var", "tipo.datos")
diccionario$nomb.var<-tolower(diccionario$nomb.var)
diccionario$nomb.var<-str_replace(diccionario$nomb.var, " ", "")
```

También se crea una columna con el nombre del proveedor. Para obtenerlo se creó una expresión que lo extrae.  Esto se logra gracias a que dicho nombre se encuentra ubicado al final de cada nombre de columna separado por un guión bajo.  Entonces el programa recorre el nombre desde el final hasta que encuentra el guión, el resultado obtenido lo pone en el campo recien creado.

```{r}
diccionario$fuente<-sub(".*_", "", diccionario$nomb.var)
head(diccionario, 5)
```

## 3. Tabla identificadores

Como esta tabla es relativamente grande: 1305.6 millones de datos, presenta problemas para cargarla con el comando más usual: read.table.  Por este motivo se utilizó el paquete "data.table"" que hace las operaciones con tablas sustancialmente más rápidas. Para la importanción se utilizó "fread".

```{r, eval=FALSE}
identificadores<-fread("identificadores1.txt")
```

A continuación se ponen como nombre de columnas las que estaban en el diccionario de datos. 

```{r, eval=FALSE}
colnames(identificadores)[2:length(colnames(identificadores))]<-diccionario$nomb.var
```

## 4. Segmentación y exportación de tabla. 

Se exportan, en primer lugar, los datos generales de las personas identificadas en los registros. Estos están constituidos por un conjunto de cinco campos: 

```{r, eval=FALSE}
write.csv(select(identificadores,id_estadistico, id_proveedor,direccion, direccion_normalizada,ag_manzana), "general.csv")
```

A continuación se genera un listado con el nombre único de los proveedores. Se obtienen 17.  

```{r}
grupos<-group_by(diccionario[9:dim(diccionario)[1],], fuente)%>%
summarize(n())
grupos
```

Las otras 17 tablas se generan y exportan con las siguientes líneas de código:

```{r, eval=FALSE}
for(i in 1:dim(grupos)[1]){
grupos$fuente[i]
index<-which((sub(".*_", "", colnames(identificadores))==grupos$fuente[i])==TRUE)[1:3]
print(head(select(identificadores,id_estadistico, id_proveedor,colnames(identificadores)[index]),3))
write.csv(select(identificadores,id_estadistico, id_proveedor,colnames(identificadores)[index]), paste0(grupos$fuente[i], ".csv"))
}
```

## 4. Almacenamiento de tabla en formato ff. 

Para manejar grandes volúmenes de información en R existe el paquete ff. Su ventaja es que copia los archivos al disco duro, aunque manteniéndolos fácilmente accesibles desde R, que se basa en la RAM. 


